<script src="/verovio-toolkit-proxy.js"></script>
<!-- <script src="/node_modules/verovio/index.js"></script> -->
<script src="/verovio-toolkit-wav.js"></script>

<style>
    .small {
        width: 210px;
        height: 297px;
        border: 2px solid purple;

    }

    .container {
        display: flex;
    }

    /* #worker {
        display: none;
    }

    #toolkit {
        display: none;
    } */
</style>

<svg width="65px" height="65px" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
    <g>
        <animateTransform attributeName="transform" type="rotate" values="0 33 33;270 33 33" begin="0s" dur="1.4s"
            fill="freeze" repeatCount="indefinite" />
        <circle fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30" stroke-dasharray="187"
            stroke-dashoffset="610">
            <animate attributeName="stroke" values="#4285F4;#DE3E35;#F7C223;#1B9A59;#4285F4" begin="0s" dur="5.6s"
                fill="freeze" repeatCount="indefinite" />
            <animateTransform attributeName="transform" type="rotate" values="0 33 33;135 33 33;450 33 33" begin="0s"
                dur="1.4s" fill="freeze" repeatCount="indefinite" />
            <animate attributeName="stroke-dashoffset" values="187;46.75;187" begin="0s" dur="1.4s" fill="freeze"
                repeatCount="indefinite" />
        </circle>
    </g>
</svg>

<h1>Worker</h1>
<button id="btnWorker">Render using worker</button>
<div id="worker">
    <p>Spinner is running</p>
    <div class="container">
        <div id="worker1" class="small"></div>
        <div id="worker2" class="small"></div>
        <div id="worker3" class="small"></div>
        <div id="worker4" class="small"></div>
        <div id="worker5" class="small"></div>
    </div>
</div>

<script>
    const fix = (svg) => {
        const r = /\d+.?\dpx/;
        return svg.replace(r, '100%').replace(r, '100%');
    }

    const workerRender = () => {
        const proxy = new VerovioToolkitProxy();
        console.log('Run verovio as a worker');
        document.getElementById('worker').style.display = 'inherit';
        // Create a new instance of VerovioToolkitProxy
        // Listen and wait for Module to emit onRuntimeInitialized
        proxy.onRuntimeInitialized().then(async () => {
            // Fetch a MEI file
            const response = await fetch('test.xml');
            const data = await response.text();
            // Set inner HTML of #score to verovio response
            // Note that method calls on VerovioToolkitProxy instances are asynchronous
            // and will return Promises. So the must be awaited with the `await`
            // keyword or `.then(() => {...})`
            const version = await proxy.getVersion();
            console.log('Worker running version ' + version);
            await proxy.setOptions({
                scale: 30,
                adjustPageHeight: true,
            });
            console.log('loadData');
            await proxy.loadData(data);
            console.log('renderToSVG 1');
            const svg1 = fix(await proxy.renderToSVG(1));
            document.getElementById('worker1').innerHTML = svg1;
            console.log('renderToSVG 2');
            const svg2 = fix(await proxy.renderToSVG(2));
            document.getElementById('worker2').innerHTML = svg2;
            console.log('renderToSVG 3');
            const svg3 = fix(await proxy.renderToSVG(3));
            document.getElementById('worker3').innerHTML = svg3;
            console.log('renderToSVG 4');
            const svg4 = fix(await proxy.renderToSVG(4));
            document.getElementById('worker4').innerHTML = svg3;
            console.log('renderToSVG 5');
            const svg5 = fix(await proxy.renderToSVG(5));
            document.getElementById('worker5').innerHTML = svg3;

            const timemap = await proxy.renderToTimemap();
            console.log(timemap);
        });
    }

    const btnWorker = document.getElementById('btnWorker');
    btnWorker.onclick = workerRender;

</script>

<h1>Toolkit</h1>
<button id="btnToolkit">Render using toolkit</button>
<div id="toolkit">
    <p>Spinner is blocked</p>
    <div class="container">
        <div id="toolkit1" class="small"></div>
        <div id="toolkit2" class="small"></div>
        <div id="toolkit3" class="small"></div>
        <div id="toolkit4" class="small"></div>
        <div id="toolkit5" class="small"></div>
    </div>
</div>


<script>
    // console.log(verovio);

    // Module.onRuntimeInitialized = function () {
    //     console.log('initialized')
    // }

    const toolkitRender = () => {
        console.log('Run verovio in default mode');
        document.getElementById('toolkit').style.display = 'inherit';
        var toolkit = new verovio.toolkit();
        (async () => {
            // Fetch a MEI file
            const version = toolkit.getVersion();
            console.log('Toolkit running version ' + version);


            const response = await fetch('test.xml');
            const data = await response.text();
            toolkit.setOptions({
                scale: 30,
                adjustPageHeight: true,
                // breaks: 'none',
            });
            toolkit.loadData(data);
            console.log('toolkit svg 1');
            const svg1 = fix(toolkit.renderToSVG(1));
            document.getElementById('toolkit1').innerHTML = svg1;
            console.log('toolkit svg 2');
            const svg2 = fix(toolkit.renderToSVG(2));
            document.getElementById('toolkit2').innerHTML = svg2;
            console.log('toolkit svg 3');
            const svg3 = fix(toolkit.renderToSVG(3));
            document.getElementById('toolkit3').innerHTML = svg3;
            console.log('toolkit svg 4');
            const svg4 = fix(toolkit.renderToSVG(4));
            document.getElementById('toolkit4').innerHTML = svg3;
            console.log('toolkit svg 5');
            const svg5 = fix(toolkit.renderToSVG(5));
            document.getElementById('toolkit5').innerHTML = svg3;

            const timemap = toolkit.renderToTimemap();
            console.log(timemap);
        })();
    }
    const btnToolkit = document.getElementById('btnToolkit');
    btnToolkit.onclick = toolkitRender;

</script>